# 批量价格管理功能

## 功能说明

新增的批量价格管理功能允许管理员在一个页面中统一查看和修改所有商品的价格信息。**每个商品的每个规格/颜色选项会展开为单独的一行**，便于精确管理每个SKU的价格。

### 主要特性

1. **规格级别的价格展示**
   - 将每个商品的每个规格/颜色（spec_info）展开为单独的一行
   - 清晰显示每个规格的名称和对应价格
   - 支持编辑每个规格的独立价格
   - 规格名称用蓝色加粗显示，更加醒目
   - 实时显示修改状态（修改的输入框会高亮显示）

2. **强大的过滤功能**
   - 按商品标题搜索
   - 按商品分类筛选
   - 按商品状态（上架/下架）筛选

3. **批量保存**
   - 支持一次性修改多个商品的多个规格价格
   - 修改后统一保存，使用数据库事务确保数据一致性
   - 保存时自动更新商品的spec_info JSON字段
   - 自动计算并更新商品的参考价格（所有规格中的最高价）
   - 保存前显示修改数量确认

4. **用户友好的界面**
   - 显示商品ID、图片、标题、分类、规格名称等关键信息
   - 每个规格的价格独立显示和编辑
   - 价格输入框支持即时编辑
   - 修改的价格会有视觉反馈（黄色高亮）
   - 规格名称用蓝色粗体突出显示

## 安装步骤

### 1. 数据库配置

执行SQL文件添加菜单项：

```bash
mysql -u your_username -p your_database < bulk_price_menu.sql
```

或者手动在FastAdmin后台添加菜单：

1. 登录后台管理系统
2. 进入 "权限管理" -> "菜单规则"
3. 找到 "商品管理" 菜单
4. 添加子菜单：
   - 名称：`goods/bulkprice`
   - 标题：批量价格管理
   - 图标：fa fa-money
   - 类型：菜单

### 2. 权限配置

在 "权限管理" -> "管理员分组" 中，为需要使用此功能的管理员组添加以下权限：

- `goods/bulkprice` - 批量价格管理页面
- `goods/bulkupdate` - 批量更新价格接口

### 3. 清除缓存

```bash
# 清除FastAdmin缓存
rm -rf runtime/cache/*
rm -rf runtime/temp/*
```

或在后台管理界面点击 "刷新缓存"

## 使用说明

### 访问批量价格管理

1. 登录后台管理系统
2. 进入 "商品管理" -> "批量价格管理"

### 筛选商品

1. 在顶部筛选栏输入条件：
   - 商品标题：支持模糊搜索
   - 分类：从下拉列表选择
   - 状态：上架/下架/全部
2. 点击 "筛选" 按钮应用筛选条件
3. 点击 "重置" 按钮清除筛选条件

### 修改价格

1. 每个商品的每个规格都会显示为单独的一行
2. 直接在表格中的价格输入框中输入新价格
3. 修改后的输入框会显示黄色高亮，表示已修改但未保存
4. 可以同时修改多个商品的多个规格价格
5. 点击 "批量保存价格" 按钮
6. 确认要保存的商品数量
7. 系统会自动更新商品的spec_info字段和参考价格
8. 系统会显示成功更新的商品数量

### 刷新数据

点击 "刷新" 按钮可以重新加载商品数据，未保存的修改会被清除。

## 文件清单

以下是新增或修改的文件：

1. **控制器**
   - `application/admin/controller/Goods.php`
     - 新增 `bulkprice()` 方法：批量价格管理页面
     - 新增 `bulkupdate()` 方法：批量更新价格接口

2. **视图**
   - `application/admin/view/goods/bulkprice.html`：批量价格管理页面模板

3. **JavaScript**
   - `public/assets/js/backend/goods.js`
     - 新增 `bulkprice` 方法：前端逻辑处理

4. **语言文件**
   - `application/admin/lang/zh-cn/goods.php`：新增中文翻译

5. **SQL脚本**
   - `bulk_price_menu.sql`：菜单添加脚本

## 技术说明

### 数据结构

- `spec_info` 字段：JSON格式存储规格信息
  ```json
  [
    {"name": "128GB 黑色", "price": 5999},
    {"name": "256GB 白色", "price": 6999}
  ]
  ```
- 组合ID格式：`{goods_id}_{spec_index}`，例如 `123_0` 表示商品123的第0个规格

### 前端技术

- Bootstrap Table：表格展示和分页
- jQuery：事件处理和AJAX请求
- FastAdmin框架：表单处理和提示信息
- 动态数据展开：将商品规格展开为多行显示

### 后端技术

- ThinkPHP 5：MVC框架
- JSON数据处理：解析和更新spec_info字段
- 数据库事务：确保批量更新的原子性
- 自动价格计算：更新规格价格后自动计算商品参考价格
- 权限控制：基于FastAdmin的权限系统

### 安全特性

- 所有价格更新都经过权限验证
- 使用数据库事务确保数据一致性
- 价格值会转换为浮点数，防止非法输入
- 支持FastAdmin的标准权限控制
- 规格索引验证：防止非法的规格索引访问

## 注意事项

1. **规格展开显示**：每个商品的每个规格都会显示为单独的一行
2. **价格保存**：修改价格后必须点击 "批量保存价格" 才会生效
3. **刷新操作**：刷新页面或点击 "刷新" 按钮会清除未保存的修改
4. **批量操作**：建议在修改大量商品价格时分批操作
5. **价格类型**：价格字段支持小数，系统会自动转换为数字类型
6. **参考价格**：保存时系统会自动将所有规格中的最高价设为商品的参考价格
7. **spec_info更新**：修改规格价格会直接更新商品的spec_info JSON字段

## 未来扩展建议

1. 添加规格批量添加功能
2. 添加价格批量调整功能（如统一上调/下调百分比）
3. 添加价格历史记录功能
4. 支持导入/导出规格价格数据（Excel格式）
5. 添加价格变更审核流程
6. 支持规格名称的批量修改
7. 添加规格库存管理功能
