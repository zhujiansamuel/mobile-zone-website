<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>テンプレートエンジン ユニットテスト</title>
<link rel="stylesheet" href="./js/qunit/qunit.css">
<script src="./js/qunit/qunit.js"></script>
<script src="../dist/template-native-debug.js"></script>

<script id="default" type="text/html"><%=value%></script>
<script id="noEscape" type="text/html"><%=#value%></script>
<script id="include" type="text/html"><%include('include-content')%></script>
<script id="include2" type="text/html"><%=include('include-content')%></script>
<script id="include3" type="text/html"><%=#include('include-content')%></script>
<script id="include-content" type="text/html"><%=#value%></script>
<script id="print" type="text/html"><%print(value, value2)%></script>
<script id="print2" type="text/html"><%=print(value, value2)%></script>
<script id="print3" type="text/html"><%=#print(value, value2)%></script>
<script id="sandbox" type="text/html"><%=typeof document%></script>
<script id="sandbox2" type="text/html"><%if (window) window.$sandbox = true;%></script>
<script id="html" type="text/html">""''\\</script>
<script id="debug-render" type="text/html"><%=a.b.c.d.e.f%></script>
<script id="debug-syntax" type="text/html"><%=a b c d e f%></script>
<script id="helper" type="text/html"><%=test (value)%></script>
<script id="helper2" type="text/html"><%=#test (value)%></script>
<script id="helper3" type="text/html"><%=#test (value)%></script>
<script id="parser" type="text/html">
<%if(0===a) {}%><%1===5?2:3%><%%>
</script>

<script>
if (!window.console) {
	window.console = {
		log: function () {}
	}
}
test('基本', function () {
	var data = {value: 'hello <em>world</em>'};
	equal(typeof template.compile('<%=value%>'), 'function', '関数にコンパイル');
	equal(template('default', data), 'hello &#60;em&#62;world&#60;/em&#62;', 'エンコードして出力');
	equal(template('noEscape', data), 'hello <em>world</em>', '生のテキストを出力');
});

test('特殊な型の変数の出力', function () {
	var data = {value: 'hello <em>world</em>'};
	equal(template('default', {value:function(){return 'hello world'}}), 'hello world', '関数型の演算後の出力');
	equal(template('default', {value:0}), '0', 'Numberタイプ出力');
	equal(template('default', {value:false}), '', 'Boolean(false)型の空値出力');
	equal(template('default', {value:true}), '', 'Boolean(true)型の空値出力');
	equal(template('default', {value:{}}), '', 'Object型の空値出力');
});

test('特殊文字の出力', function () {
	equal(template('html', {}), '""\'\'\\\\', 'エンコードして出力js特殊文字');
});

test('XSS防御テスト', function () {
	equal(template('default', {value:'<>"\'&'}), '&#60;&#62;&#34;&#39;&#38;', 'HTML文字のエスケープ');
});

test('空値の処理', function () {
	equal(template('default', {value:''}), '', '空文字列の出力');
	equal(template('default', {}), '', 'undefined空値に変換');
	equal(template('default', {value:null}), '', 'null空値に変換');
});

test('ビルトインメソッド', function () {
	var data = {value: 'hello <em>world</em>', value2: '...'};
	equal(template('include', data), 'hello <em>world</em>', 'include');
	equal(template('include2', data), 'hello <em>world</em>', '=include');
	equal(template('include3', data), 'hello <em>world</em>', '==include');
	equal(template('print', data), 'hello <em>world</em>...', 'print');
	equal(template('print2', data), 'hello <em>world</em>...', '=print');
	equal(template('print3', data), 'hello <em>world</em>...', '==print');
});

test('ヘルパーメソッド', function () {
	var data = {value: 'hello world'};
	template.helper('test', function (content) {
		return '<em>' + content + '</em>';
	});
	equal(template('helper', data), '&#60;em&#62;hello world&#60;/em&#62;', '=helper');
	equal(template('helper2', data), '<em>hello world</em>', '=helper');
	equal(template('helper2', data), '<em>hello world</em>', '==helper');
});

test('サンドボックス', function () {
	equal(template('sandbox', {}), 'undefined', '外部オブジェクトの読み取りを拒否');
	template('sandbox2', {});
	equal(window.$sandbox, undefined, '外部オブジェクト汚染の防止');
});

test('デバッグ', function () {
	var onerror = template.onerror;


	var error = null;
	template.onerror = function (e) {
		console.log(e)
		error = e;
	};
	template('debug-render-xxxxxxxxx', {});
	deepEqual({
		name: error.name,
		message: error.message
	}, {
		name: 'Render Error',
		message: 'Template not found'
	}, 'テンプレートが見つかりません');



	error = null;
	template.onerror = function (e) {
		console.log(e)
		error = e;
	};
	template('debug-render', {});
	deepEqual({
		name: error.name,
		line: error.line
	}, {
		name: 'Render Error',
		line: 1
	}, 'レンダリングエラーのデバッグ');



	error = null;
	template.onerror = function (e) {
		console.log(e)
		error = e;
	};
	template('debug-syntax', {});
	deepEqual({
		name: error.name
	}, {
		name: 'Syntax Error'
	}, '構文エラーのデバッグ');

	template.onerror = onerror;
});

test('設定機能', function () {
	template.defaults.escape = false;
	template.defaults.openTag = '{{';
	template.defaults.closeTag = '}}';
	var data = {value: 'hello <em>world</em>'};
	equal(template.compile('{{=value}}')(data), 'hello <em>world</em>', 'カスタムデリミタ');
	equal(template.compile('{{=value}}')(data), 'hello <em>world</em>', 'デフォルトのエンコード出力を無効化');

	template.defaults.escape = true;
	template.defaults.openTag = '<%';
	template.defaults.closeTag = '%>';
});

test('構文', function () {
	var value = template('parser', {});
	equal(value, '');
});
</script>
</head>
<body>
	<div id="qunit"></div>
	<div id="qunit-fixture">test markup</div>
</body>
</html>
