<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è²·å–ç”³è¾¼æ›¸æ¨¡æ¿ç¼–è¾‘å™¨</title>

    <!-- GrapesJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">

    <!-- Custom CSS for Editor -->
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        #editor-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #editor-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #editor-header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 500;
        }

        #editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        #gjs {
            flex: 1;
            border: 3px solid #444;
        }

        /* GrapesJS Panel customization */
        .gjs-cv-canvas {
            background: #f5f5f5;
        }

        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #loading-overlay.hidden {
            display: none;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success message */
        .message {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s;
        }

        .message.success {
            background: #27ae60;
            color: white;
        }

        .message.error {
            background: #e74c3c;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div id="editor-container">
        <!-- Header -->
        <div id="editor-header">
            <h1>ğŸ“ è²·å–ç”³è¾¼æ›¸ æ¨¡æ¿ç¼–è¾‘å™¨</h1>
            <div id="editor-actions">
                <button class="btn btn-info" onclick="loadTemplate()">
                    ğŸ”„ é‡æ–°åŠ è½½
                </button>
                <button class="btn btn-warning" onclick="previewTemplate()">
                    ğŸ‘ï¸ é¢„è§ˆ
                </button>
                <button class="btn btn-success" onclick="saveTemplate()">
                    ğŸ’¾ ä¿å­˜æ¨¡æ¿
                </button>
                <button class="btn btn-primary" onclick="exportCode()">
                    ğŸ“¤ å¯¼å‡ºä»£ç 
                </button>
            </div>
        </div>

        <!-- GrapesJS Editor -->
        <div id="gjs"></div>
    </div>

    <!-- GrapesJS JS -->
    <script src="https://unpkg.com/grapesjs"></script>

    <!-- GrapesJS Preset Webpage Plugin -->
    <script src="https://unpkg.com/grapesjs-preset-webpage"></script>

    <!-- jQuery for AJAX -->
    <script src="/js/jquery.js"></script>

    <script>
        let editor;

        // åˆå§‹åŒ–ç¼–è¾‘å™¨
        function initEditor(content = '') {
            editor = grapesjs.init({
                container: '#gjs',
                height: '100%',
                width: 'auto',
                storageManager: false,
                plugins: ['gjs-preset-webpage'],
                pluginsOpts: {
                    'gjs-preset-webpage': {
                        blocksBasicOpts: {
                            blocks: ['column1', 'column2', 'column3', 'column3-7', 'text', 'link', 'image', 'video', 'map'],
                            flexGrid: 1,
                        },
                        blocks: ['link-block', 'quote', 'text-basic'],
                    }
                },
                canvas: {
                    styles: [],
                    scripts: [],
                },
                deviceManager: {
                    devices: [{
                        name: 'Desktop',
                        width: '',
                    }, {
                        name: 'Tablet',
                        width: '768px',
                        widthMedia: '992px',
                    }, {
                        name: 'Mobile',
                        width: '320px',
                        widthMedia: '480px',
                    }]
                },
                panels: {
                    defaults: [{
                        id: 'basic-actions',
                        el: '.panel__basic-actions',
                        buttons: [{
                            id: 'visibility',
                            active: true,
                            className: 'btn-toggle-borders',
                            label: '<i class="fa fa-clone"></i>',
                            command: 'sw-visibility',
                        }],
                    }, {
                        id: 'panel-devices',
                        el: '.panel__devices',
                        buttons: [{
                            id: 'device-desktop',
                            label: 'ğŸ’»',
                            command: 'set-device-desktop',
                            active: true,
                            togglable: false,
                        }, {
                            id: 'device-tablet',
                            label: 'ğŸ“±',
                            command: 'set-device-tablet',
                            togglable: false,
                        }, {
                            id: 'device-mobile',
                            label: 'ğŸ“',
                            command: 'set-device-mobile',
                            togglable: false,
                        }],
                    }]
                },
            });

            // è®¾ç½®å‘½ä»¤
            editor.Commands.add('set-device-desktop', {
                run: editor => editor.setDevice('Desktop')
            });
            editor.Commands.add('set-device-tablet', {
                run: editor => editor.setDevice('Tablet')
            });
            editor.Commands.add('set-device-mobile', {
                run: editor => editor.setDevice('Mobile')
            });

            // åŠ è½½å†…å®¹
            if (content) {
                editor.setComponents(content);
            }
        }

        // åŠ è½½æ¨¡æ¿
        function loadTemplate() {
            showLoading();
            $.ajax({
                url: '/index/template_editor/get_template',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    hideLoading();
                    if (response.code === 1) {
                        // æå–æ¨¡æ¿å†…å®¹ï¼ˆå»é™¤å¤–å±‚HTMLç»“æ„ï¼‰
                        let content = extractTemplateContent(response.data);

                        if (editor) {
                            editor.setComponents(content);
                            showMessage('æ¨¡æ¿åŠ è½½æˆåŠŸ', 'success');
                        } else {
                            initEditor(content);
                        }
                    } else {
                        showMessage('åŠ è½½å¤±è´¥: ' + response.msg, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    showMessage('åŠ è½½å¤±è´¥: ' + error, 'error');
                }
            });
        }

        // æå–æ¨¡æ¿å†…å®¹
        function extractTemplateContent(html) {
            // æå– <body> æ ‡ç­¾å†…çš„å†…å®¹
            let bodyMatch = html.match(/<body[^>]*>([\s\S]*)<\/body>/i);
            if (bodyMatch) {
                return bodyMatch[1];
            }
            return html;
        }

        // ä¿å­˜æ¨¡æ¿
        function saveTemplate() {
            let html = editor.getHtml();
            let css = editor.getCss();

            // é‡æ–°ç»„è£…å®Œæ•´çš„æ¨¡æ¿
            let fullTemplate = buildFullTemplate(html, css);

            showLoading();
            $.ajax({
                url: '/index/template_editor/save_template',
                method: 'POST',
                data: {
                    content: fullTemplate
                },
                dataType: 'json',
                success: function(response) {
                    hideLoading();
                    if (response.code === 1) {
                        showMessage('ä¿å­˜æˆåŠŸï¼å¤‡ä»½æ–‡ä»¶: ' + response.backup, 'success');
                    } else {
                        showMessage('ä¿å­˜å¤±è´¥: ' + response.msg, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    showMessage('ä¿å­˜å¤±è´¥: ' + error, 'error');
                }
            });
        }

        // æ„å»ºå®Œæ•´æ¨¡æ¿
        function buildFullTemplate(html, css) {
            return `{if $rt neq 1}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
\t\t<meta charset="utf-8">
\t\t<meta http-equiv="X-UA-Compatible" content="IE=edge">
\t\t<meta name="viewport" content="width=device-width, initial-scale=1">
\t\t<script src="/js/jquery.js"></script>
\t</head>
\t
\t<body style="padding:40px 30px 0;width:774px;" id="content">
\t\t<!--startprint-->
\t\t<div  id="content1" style="width:100%;">
\t\t<div class="dcClick2">
\t\t\t\t<button class="dcClick" id="doxt" style="opacity:0;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
\t\t\t</div>
\t\t\t{/if}
\t\t<style>
${css}
\t\t</style>
\t\t\t
${html}

\t\t{if $rt neq 1}
\t</div>
\t</body>
\t<script src="/js/jspdf.debug.js"></script>
\t<script src="/js/html2canvas.min.js"></script>
\t<script>
\t\t$(document).ready(function() {
\t\t\t$(".dcClick").click(function(event) {
\t\t\t\thtml2canvas(document.body, {
\t\t\t\t\tonrendered: function(canvas) {
\t\t\t\t\t\tvar imgData = canvas.toDataURL();
\t\t\t\t\t\tvar doc = new jsPDF('p', 'pt', 'a4');
\t\t\t\t\t\tconsole.log(imgData)
\t\t\t\t\t\tvar doc = new jsPDF();
\t\t\t\t\t\tdoc.addImage(imgData, 'png', 0, 0, 210, 0);
\t\t\t\t\t\tdoc.save('è²·å–ç”³è¾¼æ›¸.pdf');
\t\t\t\t\t}
\t\t\t\t});
\t\t\t});
\t\t});
\t\tsetTimeout(doPrint(),1000);
\t\tfunction doPrint() {
\t\t\tbdhtml=window.document.body.innerHTML;
\t\t\tsprnstr="<!--startprint-->";
\t\t\teprnstr="<!--endprint-->";
\t\t\tprnhtml=bdhtml.substr(bdhtml.indexOf(sprnstr)+0);
\t\t\tprnhtml=prnhtml.substring(0,prnhtml.indexOf(eprnstr));
\t\t\twindow.document.body.innerHTML=prnhtml;
\t\t\twindow.print();
\t\t}
\t</script>
</html>
{/if}`;
        }

        // é¢„è§ˆæ¨¡æ¿
        function previewTemplate() {
            let html = editor.getHtml();
            let css = '<style>' + editor.getCss() + '</style>';

            let previewWindow = window.open('', '_blank');
            previewWindow.document.write(css + html);
            previewWindow.document.close();
        }

        // å¯¼å‡ºä»£ç 
        function exportCode() {
            let html = editor.getHtml();
            let css = editor.getCss();
            let fullTemplate = buildFullTemplate(html, css);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            let blob = new Blob([fullTemplate], { type: 'text/html' });
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'ylindex.html';
            a.click();
            URL.revokeObjectURL(url);

            showMessage('ä»£ç å·²å¯¼å‡º', 'success');
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'success') {
            let message = document.createElement('div');
            message.className = 'message ' + type;
            message.textContent = text;
            document.body.appendChild(message);

            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadTemplate();
        });
    </script>
</body>
</html>
